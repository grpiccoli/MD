$(function(){function n(n){return n.replace(/(?:^|\s)\w/g,function(n){return n.toUpperCase()})}$("#modal-action").on("show.bs.modal",function(){$("#loading").show();var t=$(this),i=$("#event").data("url"),r={Id:$("#event").attr("data-id"),DoctorId:$("#event").attr("data-doctorid"),Start:$("#event").attr("data-start"),End:$("#event").attr("data-end"),Atencion:$("#event").attr("data-atencion"),Lugar:$("#event").attr("data-lugar"),RUN:$("#event").attr("data-run"),LocId:$("#event").attr("data-locid"),Prevision:$("#event").attr("data-prevision"),__RequestVerificationToken:$("#doctor input[name = '__RequestVerificationToken']").val()};t.find(".modal-content").load(i,r,function u(){$(".selectpicker").selectpicker();$(".phone-format").keyup(function(){var i=$(this).val().replace(/\D/g,""),t,n;i.trim().length>1&&(t=libphonenumber.parsePhoneNumberFromString(i,"CL"),t.isValid()?($(this).focus().val("").val(t.formatNational()),$(this).removeClass("is-invalid"),$(this).addClass("is-valid"),$(this).parent().nextAll("span:first").empty(),n=$(this).prev().find("button"),$(this).val().toString().startsWith("9")?(n.addClass("btn-outline-success"),n.prop("disabled",!1)):($(n[0]).addClass("btn-outline-success"),$(n[0]).prop("disabled",!1)),$(".phone-format.is-invalid").length===0&&($("#btn-add-phone").prop("disabled",!1),$("button[type=submit]").prop("disabled",!1))):($(this).removeClass("is-valid"),n=$(this).prev().find("button"),n.prop("disabled",!0),n.removeClass("btn-outline-success"),t.number.length<12?$(this).focus().val("").val(new libphonenumber.AsYouType("CL").input(i)):($(this).addClass("is-invalid"),$(this).parent().nextAll("span:first").html("teléfono no válido"),$("#btn-add-phone").prop("disabled",!0),$("button[type=submit]").prop("disabled",!0))))}).trigger("keyup");$("#RUT").rut({formatOn:"keyup",validateOn:"keyup"}).on("rutInvalido",function(){$(this).removeClass("is-valid");$("button[type=submit]").prop("disabled",!0);$(this).val().trim().length!==0?($(this).addClass("is-invalid"),$('[data-valmsg-for="RUT"]').html("Rut Inválido")):($("#loading").hide(),$("#Name").val(null))}).on("rutValido",function(){$(this).removeClass("is-invalid");$(this).addClass("is-valid");$('[data-valmsg-for="RUT"]').empty();$.getJSON("https://siichile.herokuapp.com/consulta",{rut:$("#RUT").val().replace(/[^0-9Kk]/g,"")},function(t){t.error?($("#Name").val(null),$('[data-valmsg-for="RUT"]').html(t.rut+" "+t.error),$("button[type=submit]").prop("disabled",!0)):($("#loading").show(),$('[data-valmsg-for="RUT"]').empty(),$("#Name").val(n(t.razon_social.toString().toLowerCase())),$.post("/Home/GetData",{rut:$("#RUT").val().replace(/\./g,""),today:$("#Start").val()},function(n){n.nameP!==null&&(n.idtoday!==null?n.idtoday!==$("#Id").val()&&alert("este RUT ya tiene una cita para hoy"):(n.code!==""&&n.phone!==""&&($("#Phone1").val(n.code+n.phone),$("#Phone1").trigger("keyup"),n.cellphone!==null&&($("#btn-add-phone").trigger("click"),$("#Phone2").val(n.cellphone),$("#Phone2").trigger("keyup")),n.cellphoneAdditional!==null&&($("#btn-add-phone").trigger("click"),$("#Phones3").val(n.cellphoneAdditional),$("#Phone3").trigger("keyup"))),n.codeHealthcare!==null&&$("#Prevision").val(n.codeHealthcare),$(".selectpicker").selectpicker("refresh"),n.day!==null&&n.month!==null&&n.year!==null&&$("#Birth").val(n.year+"-"+n.month+"-"+n.day)));$("#loading").hide()}),$(".is-invalid").length===0&&$("button[type=submit]").prop("disabled",!1))})}).trigger("keyup");$(".btn-remove-phone").click(function(){var t,n;$(this).closest(".form-group").addClass("d-none");t=$(this).parent().parent();t.find(".phone-format").val(null);t.nextAll("span:first").empty();n=$(this).parent().prev().prev().find("a");n.attr("href","");n.removeClass("btn-outline-info");n.addClass("disabled");$("#grp-add-phone").removeClass("d-none")});$("#btn-add-phone").click(function(){var n=$(".phone-group").length-$(".phone-group.d-none").length+1;$("#phone"+n+"-group").removeClass("d-none");n===3&&$("#grp-add-phone").addClass("d-none")});$("#btn-submit").click(function(){$("#loading").show();var n=$(this).parents(".modal").find("form");t.find(".modal-content").load(n.attr("action"),n.serializeArray(),function(){$("#valid").val()==="True"?($(".modal").modal("hide"),cal.refetchEvents()):(alert($("#Message").val()),u());$(".tooltip").css("visibility","hidden");$("#loading").hide()})});$("#btn-delete").click(function(){$("#Delete").prop("checked",!0);$("#btn-submit").trigger("click")})})});$("#modal-action").on("hidden.bs.modal",function(){$(this).removeData("bs.modal");$("#modal-action .modal-content").empty()});$("#modal-action").change(function(){$.validator.unobtrusive.parse("form#modal-form")})});